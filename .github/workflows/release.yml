name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Read version from package.json
        id: package-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version from package.json: $VERSION"
      
      - name: Update manifest.json and versions.json
        run: node version-bump.mjs
        env:
          npm_package_version: ${{ steps.package-version.outputs.version }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build plugin
        run: npm run build
      
      - name: Verify build files exist
        run: |
          if [ ! -f "build/manifest.json" ] || [ ! -f "build/main.js" ] || [ ! -f "build/styles.css" ]; then
            echo "Error: Required build files are missing"
            exit 1
          fi
          echo "All build files verified"
      
      - name: Create zip archive
        run: |
          cd build
          zip -r ../obvsnip-${{ steps.package-version.outputs.version }}.zip manifest.json main.js styles.css
          cd ..
          echo "Zip archive created: obvsnip-${{ steps.package-version.outputs.version }}.zip"
      
      - name: Extract tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Tag name: $TAG_NAME"
      
      - name: Create GitHub Release
        id: create_release
        run: |
          # Use PAT if available, otherwise use GITHUB_TOKEN
          TOKEN="${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}"
          TAG_NAME="${{ steps.tag.outputs.tag }}"
          VERSION="${{ steps.package-version.outputs.version }}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          
          # Check if release already exists and delete it
          EXISTING_RELEASE=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/releases/tags/$TAG_NAME" | jq -r '.id // empty')
          
          if [ -n "$EXISTING_RELEASE" ] && [ "$EXISTING_RELEASE" != "null" ]; then
            echo "Release already exists (ID: $EXISTING_RELEASE), deleting..."
            curl -X DELETE -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$OWNER/$REPO/releases/$EXISTING_RELEASE"
          fi
          
          # Create new release
          RELEASE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag_name\": \"$TAG_NAME\",
              \"name\": \"Release $VERSION\",
              \"body\": \"Release $VERSION\n\n## Installation\n1. Download the zip file or individual files\n2. Extract to your Obsidian vault's \`.obsidian/plugins/obvsnip/\` directory\n3. Restart Obsidian\",
              \"draft\": false,
              \"prerelease\": false
            }" \
            "https://api.github.com/repos/$OWNER/$REPO/releases")
          
          UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq -r '.upload_url // empty')
          RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id // empty')
          
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
            echo "Error creating release:"
            echo "$RELEASE_RESPONSE" | jq '.'
            exit 1
          fi
          
          # Remove the {?name,label} suffix from upload_url
          UPLOAD_URL="${UPLOAD_URL%\{*}"
          
          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Release created successfully (ID: $RELEASE_ID)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload release assets
        run: |
          # Use PAT if available, otherwise use GITHUB_TOKEN
          TOKEN="${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}"
          UPLOAD_URL="${{ steps.create_release.outputs.upload_url }}"
          VERSION="${{ steps.package-version.outputs.version }}"
          
          # Function to upload a file
          upload_file() {
            local file_path=$1
            local file_name=$2
            local content_type=$3
            
            echo "Uploading $file_name..."
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: token $TOKEN" \
              -H "Content-Type: $content_type" \
              --data-binary "@$file_path" \
              "$UPLOAD_URL?name=$file_name")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "✓ Successfully uploaded $file_name"
            else
              echo "✗ Failed to upload $file_name (HTTP $HTTP_CODE)"
              echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
              exit 1
            fi
          }
          
          # Upload all files
          upload_file "obvsnip-$VERSION.zip" "obvsnip-$VERSION.zip" "application/zip"
          upload_file "build/manifest.json" "manifest.json" "application/json"
          upload_file "build/main.js" "main.js" "application/javascript"
          upload_file "build/styles.css" "styles.css" "text/css"
          
          echo "All files uploaded successfully!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

